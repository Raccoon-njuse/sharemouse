# Vibe Coding System Doc (VCS-DOC) - v1

## 系统目标
- 在局域网内实现多台计算机之间的鼠标、键盘和剪贴板共享
- 支持服务器-客户端模式，服务器端控制客户端的输入设备
- 提供快捷键/鼠标中键切换远程控制状态的功能
- 实现剪贴板内容的自动同步
- 支持跨平台（Windows和macOS）运行
- 支持鼠标滚轮方向反转配置

## 系统不变量
1. 架构模式：始终采用模块化设计，各功能模块独立运行并通过事件回调通信
2. 运行模式：系统必须以服务器或客户端模式运行，不支持混合模式
3. 网络通信：使用TCP套接字进行可靠通信，数据格式始终为JSON，包含长度前缀
4. 输入处理：鼠标、键盘事件必须经过标准化处理后再传输
5. 剪贴板同步：剪贴板内容同步必须避免循环反馈
6. 控制切换：远程控制状态只能通过服务器端的热键切换
7. 远程控制安全：服务器端只有在成功连接客户端后才能启动远程控制状态
8. 错误处理：当操作无法执行时必须提供清晰的错误提示，避免系统卡死或无响应

## 模块职责

### ShareMouseApp (main.py)
- 系统主入口，负责初始化和协调各个模块
- 解析命令行参数，确定运行模式（服务器/客户端）
- 处理系统启动和停止流程
- 管理远程控制状态和事件分发

### NetworkManager (network_manager.py)
- 负责建立和维护网络连接
- 实现服务器端的监听和客户端的连接逻辑
- 处理数据的发送和接收
- 确保数据传输的可靠性和安全性

### InputHandler (input_handler.py)
- 捕获本地鼠标和键盘事件
- 注入远程事件到本地系统
- 监听热键组合（Ctrl+Alt+S）或鼠标中键点击以切换控制状态
- 提供鼠标滚轮水平/垂直方向反转配置
- 获取屏幕尺寸并进行坐标标准化
- 提供释放所有修饰键的功能
- 实现鼠标移动事件节流机制，优化网络传输效率

### ClipboardManager (clipboard_manager.py)
- 监控本地剪贴板变化
- 同步远程剪贴板内容到本地
- 避免剪贴板内容的循环同步
- 处理剪贴板操作的异常

### Utils (utils.py)
- 提供日志配置和记录功能
- 封装通用工具函数

## 版本变更记录

### v1.1 (2025-12-24)
- **新增**：鼠标滚轮方向反转功能，支持水平和垂直方向独立配置
  - 命令行参数：`--invert-scroll-x on/off` 和 `--invert-scroll-y on/off`
  - 默认值：on（自然滚动模式）
- **新增**：支持鼠标中键点击切换远程控制状态
  - 在服务器模式下，点击鼠标中键可快速切换控制状态
  - 同时保留原有Ctrl+Alt+S热键支持
- **优化**：鼠标移动事件处理，添加节流机制
  - 将鼠标移动事件发送频率限制在约60 FPS
  - 减少网络流量，提高响应速度
- **优化**：网络连接性能，禁用Nagle算法
  - 减少TCP数据包延迟
  - 提高实时输入响应速度
- **变更**：命令行参数改进
  - 滚轮反转参数改为接受on/off值
  - 提供更灵活的配置选项

### v1 (2025-12-23)
- **修复**：服务器未连接客户端时按下热键导致卡死的问题
- **变更**：在`_on_toggle_control`方法中添加网络连接状态检查，确保只有在连接客户端时才能切换到远程控制状态
- **影响**：提高了系统稳定性，避免了在无客户端连接时不必要的资源消耗
